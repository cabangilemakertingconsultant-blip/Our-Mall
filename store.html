<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Store | Our-Mall</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
body { background:#111; color:#fff; font-family:'Segoe UI',sans-serif; padding:15px; }
h2,h3 { text-align:center; color:#FFD700; margin-bottom:15px; }
.store-logo { max-height:100px; display:block; margin:0 auto 10px; }
.product-card { background:#1c1c1c; border:1px solid #FFD700; border-radius:10px; margin-bottom:20px; padding:10px; transition: transform .2s; }
.product-card:hover { transform:scale(1.02); }
.product-img { width:100%; height:200px; object-fit:cover; border-radius:5px; }
.btn-whatsapp { background:#25D366; color:#fff; border:none; border-radius:5px; width:100%; margin-top:5px; }
</style>
</head>
<body>

<div id="storeContent" style="display:none;">
  <img id="storeLogo" class="store-logo">
  <h2 id="storeName"></h2>
  <p id="storeDirections" class="text-center"></p>
  <div class="d-flex justify-content-center mb-3">
    <a id="storeWhatsapp" target="_blank" class="btn-whatsapp w-50">Contact on WhatsApp</a>
  </div>

  <div class="row" id="productsContainer"></div>
  <div class="d-flex justify-content-center mt-3">
    <a href="index.html" class="btn btn-warning">Back to Marketplace</a>
  </div>
</div>

<script>
const supabase = supabase.createClient('https://svfgtdqcklmbfyebqtcr.supabase.co', 'sb_publishable_a_-82NkD6MUkSGW1ZdPWMQ_fM9O0Sxl');

function getStoreId(){ return new URLSearchParams(window.location.search).get('store'); }

function getLicenseStatus(store){
  if(!store.license_start) return 'Trial';
  const now = new Date();
  const end = new Date(store.license_end);
  const graceEnd = new Date(end); graceEnd.setDate(graceEnd.getDate()+7);
  if(now<=end) return 'Active';
  if(now<=graceEnd) return 'Grace';
  return 'Expired';
}

async function loadStore(){
  const storeId = getStoreId();
  if(!storeId) { alert('Store not found'); window.location='index.html'; return; }

  const { data: store } = await supabase.from('stores').select('*').eq('id',storeId).single();
  if(!store || !['Active','Grace','Trial'].includes(getLicenseStatus(store))) { alert('Store expired'); window.location='index.html'; return; }

  document.getElementById('storeLogo').src = store.logo||'';
  document.getElementById('storeName').textContent = store.name;
  document.getElementById('storeDirections').textContent = store.directions||'';
  document.getElementById('storeWhatsapp').href = `https://wa.me/${store.whatsapp}`;

  const { data: products } = await supabase.from('products').select('*').eq('store_id',storeId);
  const container = document.getElementById('productsContainer');
  container.innerHTML = (products||[]).map(p=>`
    <div class="col-md-4">
      <div class="product-card">
        <img src="${p.images?.[0]||''}" class="product-img mb-2">
        <h5>${p.name}</h5>
        <p>R${p.price}</p>
        <a href="https://wa.me/${store.whatsapp}" class="btn-whatsapp">WhatsApp</a>
      </div>
    </div>
  `).join('');

  document.getElementById('storeContent').style.display='block';
}
loadStore();
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>